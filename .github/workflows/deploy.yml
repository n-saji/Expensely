name: Expensely-Action-Deploy

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Get Runner IP
        id: ip
        run: echo "ipv4=$(curl -s https://ifconfig.me)" >> $GITHUB_OUTPUT

      - name: Whitelist Runner IP
        run: |
          aws ec2 authorize-security-group-ingress \
            --group-id ${{ secrets.AWS_SG_ID }} \
            --protocol tcp \
            --port 22 \
            --cidr ${{ steps.ip.outputs.ipv4 }}/32

      - name: Docker Hub Login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and Push Docker Image
        run: |
          IMAGE=${{ secrets.DOCKERHUB_USERNAME }}/expensely-app
          TAG=${{ github.sha }}

          docker build -t $IMAGE:$TAG -t $IMAGE:latest .
          docker push $IMAGE:$TAG
          docker push $IMAGE:latest

      - name: SSH to EC2 and deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            mkdir -p ~/app
            cat << EOF > ~/app/.env
            ALLOWED_ORIGINS=${{ secrets.ALLOWED_ORIGINS }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
            DB_URL=${{ secrets.DB_URL }}
            FRONTEND_URL=${{ secrets.FRONTEND_URL }}
            PORT=${{ secrets.PORT }}
            MAILGUN_API_KEY=${{ secrets.MAILGUN_API_KEY }}
            EOF


            IMAGE="${{ secrets.DOCKERHUB_USERNAME }}/expensely-app:latest"
            docker pull $IMAGE

            # 3. Determine active environment (Blue or Green)
            if docker ps --format '{{.Names}}' | grep -Eq "^expensely-app-blue\$"; then
              CURRENT="blue"
              NEXT="green"
              NEXT_PORT=8082
            else
              CURRENT="green"
              NEXT="blue"
              NEXT_PORT=8081
            fi

            echo "Deploying to $NEXT container on port $NEXT_PORT..."

            # 4. Start the new container on the alternate port
            docker run -d \
              --name expensely-app-$NEXT \
              -p $NEXT_PORT:8080 \
              --restart unless-stopped \
              --env-file ~/app/.env \
              $IMAGE

            # 5. Wait for the new app to initialize 
            echo "Waiting for the new container ($NEXT) to become healthy on port $NEXT_PORT..."
            MAX_RETRIES=30
            RETRY_COUNT=0
            HEALTH_URL="http://localhost:$NEXT_PORT/ping"

            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              STATUS=$(curl -s -o /dev/null -w "%{http_code}" $HEALTH_URL || echo "000")
            
              if [ "$STATUS" = "200" ]; then
                echo "Container is healthy! Proceeding with traffic switch..."
                break
              fi
            
              echo "Health check returned status $STATUS. Retrying in 2 seconds... ($((RETRY_COUNT+1))/$MAX_RETRIES)"
              sleep 2
              RETRY_COUNT=$((RETRY_COUNT+1))
            done

            # Abort if the container never became healthy
            if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
              echo "Error: New container failed to become healthy in time."
              echo "Rolling back: Stopping and removing unhealthy $NEXT container..."
              docker stop expensely-app-$NEXT || true
              docker rm expensely-app-$NEXT || true
              exit 1 # Fail the GitHub Action workflow
            fi

            # 6. Set up the Nginx configuration            
            cat << EOF > ~/app/nginx.conf
            events {}
            http {
                server {
                    listen 8080;
                    location / {
                        proxy_pass http://host.docker.internal:$NEXT_PORT;
                        proxy_set_header Host \$host;
                        proxy_set_header X-Real-IP \$remote_addr;
                        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                    }
                }
            }
            EOF

            # 7. Start or Reload Nginx Proxy
            if ! docker ps --format '{{.Names}}' | grep -Eq "^expensely-proxy\$"; then
              echo "Starting Nginx proxy..."
              docker run -d --name expensely-proxy \
                -p 8080:8080 \
                -v ~/app/nginx.conf:/etc/nginx/nginx.conf:ro \
                --add-host host.docker.internal:host-gateway \
                --restart unless-stopped \
                nginx:alpine
            else
              echo "Reloading Nginx proxy with new target..."
              docker cp ~/app/nginx.conf expensely-proxy:/etc/nginx/nginx.conf
              docker exec expensely-proxy nginx -s reload
            fi

            # 8. Safely shut down the old container
            if docker ps -a --format '{{.Names}}' | grep -Eq "^expensely-app-$CURRENT\$"; then
              echo "Stopping and removing old container ($CURRENT)..."
              docker stop expensely-app-$CURRENT
              docker rm expensely-app-$CURRENT
            fi
            
            echo "Deployement Complete!"

      - name: Revoke Runner IP
        if: always()
        run: |
          aws ec2 revoke-security-group-ingress \
            --group-id ${{ secrets.AWS_SG_ID }} \
            --protocol tcp \
            --port 22 \
            --cidr ${{ steps.ip.outputs.ipv4 }}/32
